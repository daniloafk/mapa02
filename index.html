<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DeliveryTrack - Mapa de Entregas</title>

    <!-- Mapbox GL JS -->
    <script src="https://unpkg.com/mapbox-gl@3.4.0/dist/mapbox-gl.js"></script>
    <link href="https://unpkg.com/mapbox-gl@3.4.0/dist/mapbox-gl.css" rel="stylesheet">

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- jsQR Library for optimized QR Code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <!-- External CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Map Container -->
    <div id="map"></div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyState">
        <i class="fas fa-route"></i>
        <h3>Nenhuma entrega carregada</h3>
        <p>Clique no botão verde para carregar uma planilha</p>
    </div>

    <!-- Upload Button (changes to clear button when data is loaded) -->
    <button class="sidebar-btn upload" id="actionBtn" title="Carregar planilha">
        <i class="fas fa-file-upload"></i>
    </button>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">

    <!-- Toggle Markers Button -->
    <button class="toggle-markers-btn" id="toggleMarkersBtn" onclick="toggleMarkers()" title="Mostrar/ocultar marcadores">
        <i class="fas fa-map-marker-alt"></i>
    </button>

    <!-- Address Menu Button -->
    <button class="address-menu-btn" id="addressMenuBtn" onclick="toggleAddressMenu()" title="Endereços cadastrados">
        <i class="fas fa-address-book"></i>
    </button>

    <!-- Side Menu for Addresses -->
    <div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeAddressMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <div class="side-menu-title">
                <i class="fas fa-map-marker-alt"></i>
                Endereços Cadastrados
            </div>
            <button class="side-menu-close" onclick="closeAddressMenu()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="side-menu-content">
            <div class="side-menu-empty" id="addressEmptyState">
                <i class="fas fa-inbox"></i>
                <p>Nenhum endereço cadastrado</p>
            </div>
            <div class="address-list" id="addressList" style="display: none;"></div>
        </div>
    </div>

    <!-- Register Address Button -->
    <button class="register-address-btn" id="registerAddressBtn" onclick="openQrScanner()">
        <i class="fas fa-plus-circle"></i>
        Cadastrar Endereço
    </button>

    <!-- QR Scanner Modal -->
    <div class="qr-modal-overlay" id="qrModalOverlay">
        <div class="qr-modal">
            <div class="qr-modal-header">
                <div class="qr-modal-title">
                    <i class="fas fa-qrcode"></i>
                    Escanear QR Code
                </div>
                <button class="qr-modal-close" onclick="closeQrScanner()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="qr-modal-body">
                <div class="qr-video-container" id="qrVideoContainer">
                    <video id="qrVideo" playsinline></video>
                    <canvas id="qrCanvas" style="display: none;"></canvas>
                    <div class="qr-scan-overlay">
                        <div class="qr-scan-region">
                            <div class="scan-line"></div>
                        </div>
                    </div>
                </div>

                <div class="qr-status" id="qrStatus">Posicione o QR Code no centro</div>

                <div class="qr-result" id="qrResult" style="display: none;">
                    <div class="qr-result-label">Código SPX</div>
                    <div class="qr-result-value" id="qrCodeValue"></div>
                    <div class="qr-result-address">
                        <div class="qr-result-label">Endereço</div>
                        <div class="qr-result-value" id="qrAddressValue"></div>
                    </div>
                </div>

                <button class="qr-confirm-btn" id="qrConfirmBtn" onclick="confirmRegistration()" disabled>
                    <i class="fas fa-check"></i> Confirmar Cadastro
                </button>

                <div class="qr-divider">
                    <span>ou</span>
                </div>

                <!-- Manual Selection Button -->
                <button class="manual-select-btn" id="manualSelectBtn" onclick="toggleManualSelection()">
                    <i class="fas fa-list-ol"></i> Selecionar Manualmente
                </button>

                <!-- Map Pin Selection Button -->
                <button class="map-pin-select-btn" id="mapPinSelectBtn" onclick="startMapPinSelection()">
                    <i class="fas fa-map-pin"></i> Marcar Ponto no Mapa
                </button>

                <!-- Manual Address List -->
                <div class="manual-address-list" id="manualAddressList" style="display: none;">
                    <div class="manual-list-header">
                        <span><i class="fas fa-list"></i> Endereços Disponíveis</span>
                    </div>
                    <div class="manual-list-content" id="manualListContent">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Marcador fixo no centro para seleção de ponto -->
    <div class="center-pin-marker" id="centerPinMarker">
        <svg width="40" height="50" viewBox="0 0 40 50" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="centerPinGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#FF9800;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#F57C00;stop-opacity:1" />
                </linearGradient>
            </defs>
            <path d="M20 0C8.954 0 0 8.954 0 20c0 11.046 20 30 20 30s20-18.954 20-30C40 8.954 31.046 0 20 0z"
                  fill="url(#centerPinGrad)"/>
            <circle cx="20" cy="18" r="8" fill="white"/>
        </svg>
    </div>

    <!-- Map Pin Selection Controls -->
    <div class="map-pin-controls" id="mapPinControls">
        <div class="map-pin-instructions">
            <i class="fas fa-hand-pointer"></i>
            <span>Arraste o mapa para posicionar</span>
        </div>
        <div class="map-pin-buttons">
            <button class="map-pin-btn cancel" onclick="cancelMapPinSelection()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="map-pin-btn confirm" onclick="confirmMapPinSelection()">
                <i class="fas fa-check"></i> Confirmar
            </button>
        </div>
    </div>

    <!-- Edit Address Modal -->
    <div class="edit-modal-overlay" id="editModalOverlay">
        <div class="edit-modal">
            <div class="edit-modal-header">
                <div class="edit-modal-title">
                    <i class="fas fa-edit"></i>
                    Editar Dados
                </div>
                <button class="edit-modal-close" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="edit-modal-body">
                <div class="edit-address-display" id="editAddressDisplay">
                    <p></p>
                </div>
                <div class="edit-form">
                    <div class="edit-field">
                        <label for="editName"><i class="fas fa-user"></i> Nome do Cliente</label>
                        <input type="text" id="editName" placeholder="Digite o nome...">
                    </div>
                    <div class="edit-field">
                        <label for="editPhone"><i class="fas fa-phone"></i> Telefone</label>
                        <input type="tel" id="editPhone" placeholder="(00) 00000-0000">
                    </div>
                </div>
                <button class="edit-save-btn" onclick="saveEditedAddress()">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>

    <!-- Recenter Map FAB -->
    <button class="recenter-fab" id="recenterFab" onclick="recenterMap()">
        <i class="fas fa-location-arrow"></i>
    </button>

    <!-- Cancel Navigation FAB -->
    <button class="cancel-nav-fab" id="cancelNavFab" onclick="cancelNavigation()">
        <i class="fas fa-times"></i>
    </button>

    <!-- Arrival Overlay -->
    <div class="arrival-overlay" id="arrivalOverlay">
        <div class="arrival-card">
            <div class="arrival-icon">
                <i class="fas fa-flag-checkered"></i>
            </div>
            <div class="arrival-title">Você chegou!</div>
            <div class="arrival-subtitle" id="arrivalAddress"></div>
            <button class="arrival-btn" onclick="closeArrival()">
                <i class="fas fa-check"></i> Entendido
            </button>
        </div>
    </div>

    <!-- Confirm Clear Modal -->
    <div class="modal-overlay hidden" id="confirmModal">
        <div class="modal">
            <div class="modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>Limpar todas as entregas?</h3>
            <p>Esta ação irá remover todos os pontos do mapa e limpar os dados salvos.</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">Cancelar</button>
                <button class="modal-btn confirm" onclick="confirmClear()">Limpar</button>
            </div>
        </div>
    </div>

    <!-- External JavaScript -->
    <script src="js/app.js"></script>
</body>
</html>
